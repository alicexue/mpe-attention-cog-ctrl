---
title: "Pupil data + tPCA"
author: "Alice M. Xue (alicexue@stanford.edu)" 
date: "`r format(Sys.time(), '%B %d, %Y')`"
params:
    exp_id: "MPE"
    run_models: yes
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: no
    self_contained: true
  pdf_document:
    toc: yes
    toc_depth: '3'
    self_contained: true
---

```{r setup, include=FALSE}
library(plyr)
library(tidymv)
library(Hmisc)
library(ggplot2)
library(knitr)
library(kableExtra)
library(data.table)
library(psycho)
library(lme4)
library(sjPlot)
library(afex)
library(wesanderson)
library(viridis)
library(showtext)
library(tidyverse)
library(mgcv)
library(itsadug)
library(RColorBrewer)
library(ggcorrplot)
library(devtools)
library(factoextra)
library(tidyjson)
library(purrr)
library(broom)
library(zoo)
library(psych)
library(patchwork)
library(emmeans)
library(ggpubr)
library(stats)
library(broom.mixed)
library(pracma)
library(afex)
library(stringr)
library(sjlabelled)

font_add(family = "Avenir Next",
         regular = "../utils/AvenirNext-Regular.ttf",
         bold = "../utils/AvenirNext-DemiBold.ttf",
         italic = "../utils/AvenirNext-Italic.ttf")
showtext.auto()
op <- showtext_opts()

fontfamily <- "Avenir Next"

set_theme(
  base=theme_classic(base_size = 12,
                     base_family="Avenir Next")
  
)

options(dplyr.summarise.inform = FALSE)

knitr::opts_chunk$set(dev = 'pdf') # set output device to pdf

knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message = FALSE)
```

```{r, echo=F}
source("../utils/summary_se_utils.R")
```

```{r get_behavior, echo=F}

set.seed(478)

exp_id <- params$exp_id

run_models <- params$run_models

data_ret <- fread("../../data/behavior/MPE_asso_retrieval_behavior.csv") %>% 
  mutate(key = match_response.keys,
         rt = match_response.rt * 1000)

data_recog <- fread("../../data/behavior/MPE_mismatch_recog_behavior.csv") %>% 
  mutate(rt = recognition_response.rt * 1000)

recognition_behavior <- data_recog %>%
  mutate(trialN = trials.thisTrialN) %>% 
  select(trialN,
         recognition_response.keys,
         recognition_response.rt,
         is_old,
         img,
         subjectId,
         expId) %>%
  mutate(hit = is_old & (recognition_response.keys==1)) %>%
  mutate(false_alarm = !is_old & (recognition_response.keys==1)) %>%
  mutate(miss = is_old & (recognition_response.keys==2)) %>%
  mutate(correct_rejection = !is_old & (recognition_response.keys==2)) %>%
  mutate(trial_outcome = case_when(hit ~ "Hit",
                                   false_alarm ~ "FA",
                                   miss ~ "Miss",
                                   correct_rejection ~ "CR")) %>%
  group_by(subjectId,
           trialN,
           trial_outcome,
           is_old,
           img,
           recognition_response.keys,
           expId) %>%
  summarize(recognition_response.rt = mean(recognition_response.rt)) %>%
  ungroup() 
```

```{r save_or_load_data, echo=F}
retrieval_pupil <- fread("../../data/pupil/MPE_imm_retrieval_pupil.csv") 

retrieval_pupil.del <- fread("../../data/pupil/MPE_del_retrieval_pupil.csv") 

retrieval_pupil <- bind_rows(retrieval_pupil, retrieval_pupil.del) %>% 
  mutate(expId = case_when(grepl("MPE1", subjectId) ~ "imm",
                           grepl("MPE3", subjectId) ~ "del",
                           grepl("MPE5", subjectId) ~ "del")) %>%
  mutate(across(expId, 
                factor, 
                levels=c("imm", "del"))) %>% 
  mutate(room_setup = case_when(grepl("MPE1", subjectId) ~ "1", # eeg + pupil, shared-eeg lab
                                grepl("MPE3", subjectId) ~ "2", # pupil only, shared-eeg lab
                                grepl("MPE5", subjectId) ~ "3")) # pupil only, 4th floor lab
```

```{r, echo=F}

prev_trial_data_ret <- data_ret %>% 
  mutate(hit = is_match_trial & (match_response.keys==1)) %>%
  mutate(false_alarm = !is_match_trial & (match_response.keys==1)) %>%
  mutate(miss = is_match_trial & (match_response.keys==2)) %>%
  mutate(correct_rejection = !is_match_trial & (match_response.keys==2)) %>%
  mutate(trial_outcome = case_when(hit ~ "Hit",
                                   false_alarm ~ "FA",
                                   miss ~ "Miss",
                                   correct_rejection ~ "CR")) %>% 
  group_by(subjectId, block_n) %>% 
  mutate(trials.thisTrialN = trials.thisTrialN+1) %>% 
  mutate(previous_trial_outcome = trial_outcome) %>% 
  mutate(previous_trial_association_strength = association_strength) %>% 
  mutate(trialN_block = trials.thisTrialN) %>% 
  select(subjectId, block_n, trialN_block, 
         previous_trial_outcome, previous_trial_association_strength)

```


```{r labels, echo=F}

palette <- c("#008080", "#9fdfbf")
hit_miss_palette <- c("#6E9075", "#FC7753")

ret_labels_strong <- tibble(event = c("cue", "delay", "probe", "ITI"),
                            time = c(0, 1, 2, 2.75))

ret_labels_weak <- tibble(event = c("cue", "delay", "probe", "ITI"),
                          time = c(0, 1, 2, 2.75))

ret_labels <- rbind(ret_labels_strong, ret_labels_weak)
ret_labels$position <- 0.12
```

```{r, echo=F}
load("tpca_models.RData")
```


# Temporal PCA

## Trial level

```{r tempPCA_trial, echo=F}
subj_timeseries_trial <- retrieval_pupil %>% 
  mutate(pupil_diameter = pupil_diameter_z)

subj_timeseries_trial %>% 
  pivot_wider(id_cols = c("subjectId", 
                          "expId", 
                          "room_setup",
                          "trial_outcome", 
                          "match_response.rt",
                          "association_strength", 
                          "trialN", 
                          "img"),
              names_from = c("time"), 
              values_from = c("pupil_diameter")) %>% 
  mutate(across(trial_outcome, 
                factor, 
                levels=c("Hit", "CR", "Miss", "FA"))) %>% 
  group_by(trial_outcome, association_strength) %>% 
  summarize(count = n()) %>% 
  ungroup() %>% 
  mutate(total_ntrials = sum(count)) %>% 
  mutate(percent_data = round(count / total_ntrials * 100, 2)) %>% 
  kable() %>% 
  kable_styling(bootstrap_options = "striped", 
                full_width = F, 
                position = "left")

subj.data <- subj_timeseries_trial %>% 
  pivot_wider(id_cols = c("trial_outcome",
                          "association_strength", 
                          "subjectId",
                          "expId",
                          "room_setup",
                          "trialN",
                          "img",
                          "trialN_block", 
                          "match_response.rt",
                          "block"),
              names_from = c("time"), 
              values_from = c("pupil_diameter"))

pca_input <- subj.data %>% 
  select(-trial_outcome, 
         -association_strength, 
         -subjectId, 
         -expId,
         -room_setup,
         -match_response.rt,
         -trialN, 
         -img, 
         -trialN_block, 
         -block) 

ncomp <- 6
pc_names <- paste("PC", 1:ncomp, sep = "")
data.pca        <- prcomp(pca_input, center=T, scale=T)

# scree plot
plot(data.pca)

# change the sign of PC4 columns to flip the sign of the loadings
rot <- data.pca$rotation
rot[, c(4)] <- rot[, c(4)] * -1
data.pca$rotation <- rot

raw.loadings     <- data.pca$rotation[,1:ncomp] %*% diag(data.pca$sdev, ncomp, ncomp)
rotated.loadings <- varimax(raw.loadings)$loadings
inv.loadings     <- t(pracma::pinv(rotated.loadings))
loadings         <- rotated.loadings
scores           <- scale(pca_input) %*% inv.loadings
subj.pred        <- as_tibble(scores) %>% 
  rename_with(~ gsub("V", "PC", .))

fviz_eig(data.pca, addlabels = TRUE)

pca.loadings <- as_tibble(matrix(as.numeric(loadings), 
                                 attributes(loadings)$dim, 
                                 dimnames=attributes(loadings)$dimnames), 
                          rownames="time") %>% 
  mutate(time = as.numeric(time)) 

pca.loadings <- pca.loadings %>% 
  rename_with(~ gsub("V", "PC", .))

ss_loadings <- colSums(loadings^2)

var_explained <- as_tibble(ss_loadings/nrow(loadings)) %>% 
  mutate(percent_var_explained = value * 100) %>% 
  add_column(component = pc_names)

var_explained <- var_explained %>% 
  arrange(desc(percent_var_explained)) %>% 
  mutate(component_renamed = paste("PC", row_number(), sep=""))

pca.loadings <- pca.loadings %>% 
  pivot_longer(cols = pc_names, 
               names_to = "component",
               values_to = "loading") %>% 
  left_join(var_explained, by=c("component")) %>% 
  rename(component_orig = component,
         component = component_renamed)

# ordered by "peak time"
ordered_pcs <- c("PC2",
                 "PC5",
                 "PC1",
                 "PC6",
                 "PC3",
                 "PC4")


component_order_with_var_explained <- c("PC2: 25.82%",
                                        "PC5: 5.87%",
                                        "PC1: 28.78%",
                                        "PC6: 1.79%",
                                        "PC3: 19.24%",
                                        "PC4: 14.69%")

```

```{r plot_pc_loadings, echo=F}

rainbow <- c("#E82C42", 
             "#F46D43", 
             "#FFCC00", 
             "#29A343", 
             "#1E8DD2", 
             "#59169C")

pca.loadings %>% 
  mutate(component = paste(component, ": ", round(percent_var_explained, 2),
                           "%",
                           sep = "")) %>% 
  ggplot(aes(x = time, 
             y = loading,
             color = component,
             fill = component)) +
  geom_vline(xintercept = c(0, 1, 2, 2.75),
             linetype = "dashed",
             color = "gray37") +
  geom_line(linewidth=1) +
  geom_text(aes(label = event,
                x = time,
                y = 0.75),
            data = ret_labels,
            inherit.aes = FALSE,
            angle = 90, 
            hjust = 1,
            vjust = 1.2,
            size = 3,
            colour = "gray37",
            family = fontfamily) + 
  labs(x = "Time (s)",
       y = "PC loading",
       title = "Components extracted by temporal PCA") +
  scale_color_manual(values=rainbow, name="")

pca.loadings %>% 
  mutate(component = paste(component, ": ", round(percent_var_explained, 2),
                           "%",
                           sep = "")) %>% 
  mutate(across(component,
                factor,
                levels=component_order_with_var_explained)) %>%
  ggplot(aes(x = time, 
             y = loading,
             color = component,
             fill = component)) +
  geom_vline(xintercept = c(0, 1, 2, 2.75),
             linetype = "dashed",
             color = "gray37") +
  geom_line(linewidth=1.2) +
  geom_text(aes(label = event,
                x = time,
                y = 0.9),
            data = ret_labels,
            inherit.aes = FALSE,
            angle = 90, 
            hjust = 1,
            vjust = 1.2,
            size = 6,
            colour = "gray37",
            family = fontfamily) + 
  labs(x = "Time (s)",
       y = "PC loading",
       title = "Components extracted by temporal PCA") +
  scale_color_manual(values=rainbow, name="") +
  theme(text = element_text(size=15))

pca.loadings %>% 
  mutate(component = paste(component, ": ", round(percent_var_explained, 2),
                           "%",
                           sep = "")) %>% 
  ggplot(aes(x = time, 
             y = loading,
             color = component,
             fill = component)) +
  geom_vline(xintercept = c(0, 1, 2, 2.75),
             linetype = "dashed",
             color = "gray37") +
  geom_line(color="black", linewidth=1) +
  geom_text(aes(label = event,
                x = time,
                y = 0.75),
            data = ret_labels,
            inherit.aes = FALSE,
            angle = 90, 
            hjust = 1,
            vjust = 1.2,
            size = 3,
            colour = "gray37",
            family = fontfamily) + 
  facet_wrap(~component) +
  labs(x = "Time (s)",
       y = "PC loading",
       title = "Temporal PCA") +
  scale_color_brewer(palette="Set2") + 
  theme(legend.position = "none")

subj.data.scores <- subj.data %>% 
  add_column(subj.pred) %>% 
  pivot_longer(cols = pc_names, 
               names_to = "component",
               values_to = "component_score") %>% 
  left_join(var_explained, by=c("component")) %>% 
  rename(component_orig = component,
         component = component_renamed)

scores <- subj.data.scores %>% 
  select(subjectId, 
         expId, 
         room_setup,
         trialN, 
         img,
         trialN_block,
         block,
         trial_outcome, 
         association_strength,
         component,
         component_score)

save(loadings,
     inv.loadings,
     subj.data.scores,
     file="pupil_tPCA.RData")
write.csv(scores, "pupil_tPCA_scores.csv")
write.csv(pca.loadings, "pupil_tPCA_loadings.csv")

```

```{r loadings_joint_plt, echo=F, fig.width=7, fig.height=10}
### joint plot
loadings.plt <- pca.loadings %>% 
  mutate(component = paste(component, ": ", round(percent_var_explained, 2),
                           "%",
                           sep = "")) %>% 
  ggplot(aes(x = time, 
             y = loading,
             color = component,
             fill = component)) +
  geom_vline(xintercept = c(0, 1, 2, 2.75),
             linetype = "dashed",
             color = "gray37") +
  geom_line(color="black", linewidth=1) +
  geom_text(aes(label = event,
                x = time,
                y = 0.75),
            data = ret_labels,
            inherit.aes = FALSE,
            angle = 90, 
            hjust = 1,
            vjust = 1,
            size = 3,
            colour = "gray37",
            family = fontfamily) + 
  facet_wrap(~component, ncol=1) +
  labs(x = "Time (s)",
       y = "PC loading") +
  theme(legend.position = "none")

scores.plt <- subj.data.scores %>% 
  mutate(across(trial_outcome, 
                factor, 
                levels=c("Hit", "CR", "Miss", "FA"))) %>%
  group_by(subjectId, association_strength, trial_outcome, component) %>% 
  summarize(component_score = mean(component_score)) %>% 
  summarySEwithin(., 
                  measurevar="component_score", 
                  withinvars=c("association_strength",
                               "trial_outcome",
                               "component"), 
                  idvar="subjectId") %>% 
  ggplot(aes(x = trial_outcome,
             y = component_score,
             fill = association_strength)) +
  stat_summary(fun = "mean", 
               geom = "bar", 
               color = "black", 
               position=position_dodge()) +
  geom_errorbar(aes(ymin=component_score-se, ymax=component_score+se),
                position=position_dodge(.9), 
                width=.2) +
  facet_wrap(~component, scales = "free", ncol=1) +
  scale_color_manual(values=palette, name="") +
  scale_fill_manual(values=palette, name="") +
  labs(x = "", y = "PC score")

loadings.plt + scores.plt

scores.plt <- subj.data.scores %>% 
  mutate(across(trial_outcome, 
                factor, 
                levels=c("Hit", "CR", "Miss", "FA"))) %>%
  group_by(subjectId, association_strength, trial_outcome, component) %>% 
  summarize(component_score = mean(component_score)) %>% 
  summarySEwithin(., 
                  measurevar="component_score", 
                  withinvars=c("association_strength",
                               "trial_outcome",
                               "component"), 
                  idvar="subjectId") %>% 
  ggplot(aes(x = association_strength,
             y = component_score,
             fill = trial_outcome)) +
  stat_summary(fun = "mean", 
               geom = "bar", 
               color = "black", 
               position=position_dodge()) +
  geom_errorbar(aes(ymin=component_score-se, ymax=component_score+se),
                position=position_dodge(.9), 
                width=.2) +
  facet_wrap(~component, scales = "free", ncol=1) +
  scale_color_manual(values=c("#1a75ff", "#ff751a", "#80b3ff", "#ffb380"), name="") +
  scale_fill_manual(values=c("#1a75ff", "#ff751a", "#80b3ff", "#ffb380"), name="") +
  labs(x = "", y = "PC score")

loadings.plt + scores.plt
```

### Models

Match v. mismatch, correct v. incorrect 

```{r match_mismatch_acc_models, echo=F, eval=run_models, fig.width=6.5, fig.height=3, results="asis"}

models <- c()
models.compact.no.mismatch <- c()
models.compact.no.accuracy <- c()
compact.pc2.accuracy.only.model <- c()

for (i in 1:ncomp) {
  
  print(paste("PC", i))
  mod.data <- subj.data.scores %>% 
    dplyr::filter(component == paste("PC", i, sep="")) %>% 
    mutate(is_mismatch = if_else(trial_outcome %in% c("Hit", "Miss"),
                                 0,
                                 1)) %>%
    mutate(is_incorrect = if_else(trial_outcome %in% c("Hit", "CR"),
                                  0,
                                  1))
  
  mod <- mod.data %>% 
    lmer(component_score ~ is_mismatch * is_incorrect * association_strength + 
           (is_mismatch * is_incorrect * association_strength | subjectId) +
           (1 | expId), 
         # + (1 | expId:room_setup),
         data = .)
  
  if (isSingular(mod) | any(grepl("failed to converge", mod@optinfo$conv$lme4$messages))) {
    mod <- mod.data %>% 
      lmer(component_score ~ is_mismatch * is_incorrect * association_strength + 
             (is_mismatch * is_incorrect * association_strength | subjectId),
           data = .)
  }
  
  if (isSingular(mod) | any(grepl("failed to converge", mod@optinfo$conv$lme4$messages))) {
    mod <- mod.data %>% 
      lmer(component_score ~ is_mismatch * is_incorrect * association_strength + 
             (is_mismatch + is_incorrect + association_strength | subjectId) +
             (1 | expId), 
           # + (1 | expId:room_setup),
           data = .)
  }
  
  if (isSingular(mod) | any(grepl("failed to converge", mod@optinfo$conv$lme4$messages))) {
    mod <- mod.data %>% 
      lmer(component_score ~ is_mismatch * is_incorrect * association_strength + 
             (is_mismatch + is_incorrect + association_strength | subjectId),
           data = .)
  }
  
  if (isSingular(mod) | any(grepl("failed to converge", mod@optinfo$conv$lme4$messages))) {
    mod <- mod.data %>% 
      lmer(component_score ~ is_mismatch * is_incorrect * association_strength + 
             (1 | subjectId) +
             (1 | expId), 
           # + (1 | expId:room_setup),
           data = .)
  }
  
  if (isSingular(mod) | any(grepl("failed to converge", mod@optinfo$conv$lme4$messages))) {
    mod <- mod.data %>% 
      lmer(component_score ~ is_mismatch * is_incorrect * association_strength + 
             (1 | subjectId),
           data = .)
  }
  
  final.mod.formula <- formula(mod) [3]
  final.mod.formula <- paste("component_score ~", final.mod.formula)
  no.mismatch.formula <- gsub("is_mismatch \\* ", "", final.mod.formula)
  no.mismatch.formula <- gsub("is_mismatch \\+ ", "", no.mismatch.formula)
  no.accuracy.formula <- gsub("is_incorrect \\* ", "", final.mod.formula)
  no.accuracy.formula <- gsub("is_incorrect \\+ ", "", no.accuracy.formula)
  
  if (i == 2) {
    compact.pc2.accuracy.only.model <- mod.data %>% 
      lmer(component_score ~ is_incorrect + 
             (1 | subjectId),
           data = .)
  }
  
  mod.no.mismatch <- mod.data %>% 
    lmer(as.formula(no.mismatch.formula),
         data = .)
  
  if (isSingular(mod.no.mismatch) | any(grepl("failed to converge", mod.no.mismatch@optinfo$conv$lme4$messages))) {
    mod.no.mismatch <- mod.data %>% 
      lmer(component_score ~ is_incorrect * association_strength + 
             (is_incorrect + association_strength | subjectId),
           # (1 | expId) + (1 | expId:room_setup),
           data = .)
  }
  
  if (isSingular(mod.no.mismatch) | any(grepl("failed to converge", mod.no.mismatch@optinfo$conv$lme4$messages))) {
    mod.no.mismatch <- mod.data %>% 
      lmer(component_score ~ is_incorrect * association_strength + 
             (1 | subjectId),
           # (1 | expId) + (1 | expId:room_setup),
           data = .)
  }
  
  ### remove accuracy term
  
  mod.no.accuracy <- mod.data %>% 
    lmer(as.formula(no.accuracy.formula),
         data = .)
  
  if (isSingular(mod.no.accuracy) | any(grepl("failed to converge", mod.no.accuracy@optinfo$conv$lme4$messages))) {
    mod.no.accuracy <- mod.data %>% 
      lmer(component_score ~ is_mismatch * association_strength + 
             (is_mismatch + association_strength | subjectId),
           # (1 | expId) + (1 | expId:room_setup),
           data = .)
  }
  
  if (isSingular(mod.no.accuracy) | any(grepl("failed to converge", mod.no.accuracy@optinfo$conv$lme4$messages))) {
    mod.no.accuracy <- mod.data %>% 
      lmer(component_score ~ is_mismatch * association_strength + 
             (1 | subjectId),
           # (1 | expId) + (1 | expId:room_setup),
           data = .)
  }
  
  models <- c(models, mod)
  models.compact.no.mismatch <- c(models.compact.no.mismatch, mod.no.mismatch)
  models.compact.no.accuracy <- c(models.compact.no.accuracy, mod.no.accuracy)
  
}

```

```{r show_match_mismatch_acc_models, echo=F, eval=T, fig.width=6.5, fig.height=3, results="asis"}

for (i in 1:ncomp) {
  
  fig1 <- pca.loadings %>% 
    dplyr::filter(component == paste("PC", i, sep="")) %>% 
    mutate(component = paste(component, ": ", round(percent_var_explained, 2),
                             "%",
                             sep = "")) %>% 
    ggplot(aes(x = time, 
               y = loading,
               color = component,
               fill = component)) +
    geom_vline(xintercept = c(0, 1, 2, 2.75),
               linetype = "dashed",
               color = "gray37") +
    geom_line(color="black", linewidth=1) +
    geom_text(aes(label = event,
                  x = time,
                  y = 0.75),
              data = ret_labels,
              inherit.aes = FALSE,
              angle = 90, 
              hjust = 1,
              vjust = 1.2,
              size = 3,
              colour = "gray37",
              family = fontfamily) + 
    facet_wrap(~component) +
    labs(x = "Time (s)",
         y = "PC loading") +
    scale_color_brewer(palette="Set2") + 
    scale_fill_brewer(palette="Set2") +
    theme(legend.position = "none")
  
  
  fig2 <- subj.data.scores %>% 
    dplyr::filter(component == paste("PC", i, sep="")) %>% 
    group_by(subjectId, association_strength, trial_outcome, component) %>% 
    summarize(component_score = mean(component_score)) %>% 
    summarySEwithin(., 
                    measurevar="component_score", 
                    withinvars=c("association_strength",
                                 "trial_outcome",
                                 "component"), 
                    idvar="subjectId") %>% 
    mutate(across(trial_outcome, 
                  factor, 
                  levels=c("Hit", "CR", "Miss", "FA"))) %>%
    ggplot(aes(x = association_strength,
               y = component_score,
               fill = trial_outcome)) +
    stat_summary(fun = "mean", 
                 geom = "bar", 
                 color = "black", 
                 position=position_dodge()) +
    geom_errorbar(aes(ymin=component_score-se, ymax=component_score+se),
                  position=position_dodge(.9), 
                  width=.2) +
    facet_wrap(~component, scales = "free") +
    scale_color_manual(values=c("#1a75ff", "#ff751a", "#80b3ff", "#ffb380"), name="") +
    scale_fill_manual(values=c("#1a75ff", "#ff751a", "#80b3ff", "#ffb380"), name="") +
    labs(x = "", y = "PC score")
  
  print(fig1 + fig2)
  
  mod <- models[[i]]
  mod.no.mismatch <- models.compact.no.mismatch[[i]]
  mod.no.accuracy <- models.compact.no.accuracy[[i]]
  title <- formula(mod) [3]
  title <- gsub("is_mismatch", "Mismatch", title)
  title <- gsub("is_incorrect", "Accuracy", title)
  title <- gsub("association_strength", "Strength", title)
  title <- gsub(":", " x ", title)
  tidy(mod, effects = "fixed", conf.int = T, conf.level = 0.95) %>% 
    mutate(CI = paste0("[", 
                       sprintf("%.03f", conf.low), 
                       ", ", 
                       sprintf("%.03f", conf.high), 
                       "]", 
                       sep="")) %>% 
    select(term, estimate, CI, p.value, std.error, df) %>% 
    rename("Estimate" = estimate,
           "p-value" = p.value,
           "SE" = std.error,
           "DF" = df
    ) %>% 
    mutate(term = gsub("is_mismatch", "Mismatch", term),
           term = gsub("is_incorrect", "Accuracy", term),
           term = gsub("association_strengthWeak \\(1x\\)", "Strength", term),
           term = gsub(":", " x ", term)) %>% 
    kable(caption=paste("PC", i, " score ~ ", title, sep=""),
          digits=3) %>% 
    kable_styling() %>% 
    cat()
  
  tidy(mod, effects = "ran_pars", scales = "vcov") %>% 
    select(term, estimate) %>% 
    mutate(term = gsub("var__", "Variance ", term),
           term = gsub("cov__", "Covariance ", term),
           term = gsub("\\(Intercept\\)", "intercept", term),
           term = gsub("is_mismatch", "Mismatch", term),
           term = gsub("is_incorrect", "Accuracy", term),
           term = gsub("association_strengthWeak \\(1x\\)", "Strength", term),
           term = gsub("\\.", ", ", term)) %>% 
    kable(digits=3, caption="Random effects") %>% 
    kable_styling() %>% 
    cat()
  
  anova(mod.no.mismatch, mod, test="LRT") %>% 
    tidy() %>% 
    kable(caption=paste("mod.no.mismatch:", 
                        formula(mod.no.mismatch) [3])) %>% 
    kable_styling() %>% 
    cat()
  
  print(paste("No mismatch compact model failed to converge: ",
              isSingular(mod.no.mismatch) | any(grepl("failed to converge", mod.no.mismatch@optinfo$conv$lme4$messages))))
  
  anova(mod.no.accuracy, mod, test="LRT") %>% 
    tidy() %>% 
    kable(caption=paste("mod.no.accuracy:", 
                        formula(mod.no.accuracy) [3])) %>% 
    kable_styling() %>% 
    cat()
  
  print(paste("No accuracy compact model failed to converge: ",
              isSingular(mod.no.accuracy) | any(grepl("failed to converge", mod.no.accuracy@optinfo$conv$lme4$messages))))
  
  if (i == 2) {
    anova(compact.pc2.accuracy.only.model, mod, test="LRT") %>% 
      tidy() %>% 
      kable(caption=paste("mod.only.accuracy:", 
                          formula(compact.pc2.accuracy.only.model) [3])) %>% 
      kable_styling() %>% 
      cat()
  }
  
  emm <- emmeans(mod, ~ is_mismatch | is_incorrect | association_strength, adjust="bonferroni")
  emm.pairs <- pairs(emm)
  tidy(emm.pairs, effects = "fixed", conf.int = T, conf.level = 0.95) %>% 
    select(association_strength, is_incorrect, contrast, estimate, conf.low, conf.high, p.value, std.error) %>% 
    kable(digits=3, caption=paste("PC", i, "; Pairwise comparisons", sep="")) %>% 
    kable_styling() %>% 
    cat()
  
  emm <- emmeans(mod, ~ is_incorrect | is_mismatch | association_strength, adjust="bonferroni")
  emm.pairs <- pairs(emm)
  tidy(emm.pairs, effects = "fixed", conf.int = T, conf.level = 0.95) %>% 
    select(association_strength, is_mismatch, contrast, estimate, conf.low, conf.high, p.value, std.error) %>% 
    kable(digits=3, caption=paste("PC", i, "; Pairwise comparisons", sep="")) %>% 
    kable_styling() %>% 
    cat()
  
  emm <- emmeans(mod, ~ is_incorrect | association_strength, adjust="bonferroni")
  emm.pairs <- pairs(emm)
  tidy(emm.pairs, effects = "fixed", conf.int = T, conf.level = 0.95) %>% 
    select(association_strength, contrast, estimate, conf.low, conf.high, p.value, std.error) %>% 
    kable(digits=3, caption=paste("PC", i, "; Pairwise comparisons", sep="")) %>% 
    kable_styling() %>% 
    cat()
  
}

```


```{r full_model_all_pc, echo=F, eval=F}

mod <- subj.data.scores %>% 
  mutate(is_mismatch = if_else(trial_outcome %in% c("Hit", "Miss"),
                               0,
                               1)) %>%
  mutate(is_incorrect = if_else(trial_outcome %in% c("Hit", "CR"),
                                0,
                                1)) %>%
  lmer(component_score ~ component * is_mismatch * is_incorrect * association_strength + 
         (component + is_mismatch + is_incorrect + association_strength | subjectId),
       # (1 | expId) + (1 | expId:room_setup),
       data = .) 


mod %>% 
  summary()

tidy(mod, effects = "fixed", conf.int = T, conf.level = 0.95) %>% 
  select(term, estimate, conf.low, conf.high, p.value, std.error, df) %>% 
  kable(digits=3) %>% 
  kable_styling()

tidy(mod, effects = "ran_pars", scales = "vcov") %>% 
  select(term, estimate) %>% 
  kable(digits=3, caption="Random effects") %>% 
  kable_styling()

```


## Match/Mismatch RT

```{r get_rt_data_obj, echo=F}
### joint plot
rt_data <- subj.data.scores %>% 
  mutate_at(c('trial_outcome'), as.character) %>% 
  mutate(trial_outcome=replace(trial_outcome, trial_outcome=="Hit", "Match")) %>%
  mutate(trial_outcome=replace(trial_outcome, trial_outcome=="CR", "Mismatch")) %>%
  dplyr::filter(trial_outcome %in% c("Match", "Mismatch"))
```

```{r match_mismatch_rt, echo=F, eval=run_models, fig.width=7, fig.height=10}
models.rt <- c()

for (pc in 1:ncomp) {
  mod <- rt_data %>% 
    dplyr::filter(component == paste("PC", pc, sep="")) %>% 
    mutate(match_response.rt = log(match_response.rt)) %>%  
    lmer(match_response.rt ~ component_score * association_strength * trial_outcome +
           (component_score * association_strength * trial_outcome | subjectId) + 
           (1 | expId),
         data = .)
  
  if (isSingular(mod) | any(grepl("failed to converge", mod@optinfo$conv$lme4$messages))) {
    mod <- rt_data %>% 
      dplyr::filter(component == paste("PC", pc, sep="")) %>% 
      mutate(match_response.rt = log(match_response.rt)) %>%  
      lmer(match_response.rt ~ component_score * association_strength * trial_outcome +
             (component_score * trial_outcome * association_strength | subjectId),
           data = .)
  }
  
  if (isSingular(mod) | any(grepl("failed to converge", mod@optinfo$conv$lme4$messages))) {
    mod <- rt_data %>% 
      dplyr::filter(component == paste("PC", pc, sep="")) %>% 
      mutate(match_response.rt = log(match_response.rt)) %>%  
      lmer(match_response.rt ~ component_score * association_strength * trial_outcome +
             (component_score + trial_outcome + association_strength | subjectId) + 
             (1 | expId),
           data = .)
  }
  
  if (isSingular(mod) | any(grepl("failed to converge", mod@optinfo$conv$lme4$messages))) {
    mod <- rt_data %>% 
      dplyr::filter(component == paste("PC", pc, sep="")) %>% 
      mutate(match_response.rt = log(match_response.rt)) %>%  
      lmer(match_response.rt ~ component_score * association_strength * trial_outcome +
             (component_score + trial_outcome + association_strength | subjectId),
           data = .)
  }
  
  if (isSingular(mod) | any(grepl("failed to converge", mod@optinfo$conv$lme4$messages))) {
    mod <- rt_data %>% 
      dplyr::filter(component == paste("PC", pc, sep="")) %>% 
      mutate(match_response.rt = log(match_response.rt)) %>%  
      lmer(match_response.rt ~ component_score * association_strength * trial_outcome +
             (component_score | subjectId) + 
             (1 | expId),
           data = .)
  }
  
  if (isSingular(mod) | any(grepl("failed to converge", mod@optinfo$conv$lme4$messages))) {
    mod <- rt_data %>% 
      dplyr::filter(component == paste("PC", pc, sep="")) %>% 
      mutate(match_response.rt = log(match_response.rt)) %>%  
      lmer(match_response.rt ~ component_score * association_strength * trial_outcome +
             (1 | subjectId),
           data = .)
  }
  
  if (isSingular(mod) | any(grepl("failed to converge", mod@optinfo$conv$lme4$messages))) {
    print(paste("MODEL DID NOT CONVERGE FOR PC", pc))
  }
  
  models.rt <- c(models.rt, mod)
  
}
```


```{r binned_rt, echo=F, fig.width=7, fig.height=10}

nbins <- 4

rt.binned.plt <- rt_data %>% 
  group_by(subjectId, component, association_strength, trial_outcome) %>%
  mutate(trial_count = n()) %>%
  ungroup() %>%
  dplyr::filter(trial_count > nbins-1) %>%
  group_by(subjectId, component, association_strength, trial_outcome) %>% 
  mutate(component_score_bin = cut_interval(component_score, 
                                            n = nbins,
                                            labels = F)) %>% 
  ungroup() %>% 
  group_by(subjectId, trial_outcome, association_strength,
           component, component_score_bin) %>% 
  summarize(rt = median(match_response.rt)) %>% 
  summarySEwithin(., 
                  measurevar="rt", 
                  withinvars=c("association_strength",
                               "trial_outcome",
                               "component",
                               "component_score_bin"), 
                  idvar="subjectId") %>% 
  # mutate(across(component,
  #               factor,
  #               levels=ordered_pcs)) %>% 
  ggplot(aes(x = as.numeric(as.character(component_score_bin)),
             y = rt,
             color = trial_outcome,
             group = trial_outcome)) +
  geom_line(linewidth=0.8) +
  geom_point(size=1.5) +
  geom_errorbar(aes(ymin=rt-se, ymax=rt+se),
                width=0.2) +
  facet_grid(rows=vars(component), 
             cols=vars(association_strength),
             axes="all_x",
             scales = "free") +
  scale_color_manual(values=c("#1a75ff", "#ff751a"), name="") +
  scale_fill_manual(values=c("#1a75ff", "#ff751a"), name="") +
  labs(x = "PC score quartile", y = "RT (s)") +
  theme(strip.text.y = element_blank())

loadings.plt + rt.binned.plt +
  plot_layout(widths=c(1,2))

```

### Models

```{r show_mismatch_rt_models, echo=F, fig.width=6.5, fig.height=3, results="asis"}
for (pc in 1:ncomp) {
  fig1 <- pca.loadings %>% 
    dplyr::filter(component == paste("PC", pc, sep="")) %>% 
    mutate(component = paste(component, ": ", round(percent_var_explained, 2),
                             "%",
                             sep = "")) %>% 
    ggplot(aes(x = time, 
               y = loading,
               color = component,
               fill = component)) +
    geom_vline(xintercept = c(0, 1, 2, 2.75),
               linetype = "dashed",
               color = "gray37") +
    geom_line(color="black", linewidth=1) +
    geom_text(aes(label = event,
                  x = time,
                  y = 0.75),
              data = ret_labels,
              inherit.aes = FALSE,
              angle = 90, 
              hjust = 1,
              vjust = 1.2,
              size = 3,
              colour = "gray37",
              family = fontfamily) + 
    facet_wrap(~component) +
    labs(x = "Time (s)",
         y = "PC loading") +
    scale_color_brewer(palette="Set2") + 
    scale_fill_brewer(palette="Set2") +
    theme(legend.position = "none")
  
  mod <- models.rt[[pc]]
  fig2 <- mod %>% 
    plot_model(type="pred",
               terms=c("component_score[all]",
                       "trial_outcome[all]",
                       "association_strength[Strong (4x), Weak (1x)]")) +
    scale_color_manual(values=c("#1a75ff", "#ff751a"), name="") +
    scale_fill_manual(values=c("#1a75ff", "#ff751a"), name="") +
    labs(y = "RT (s)") + 
    theme(plot.title=element_blank(),
          axis.title.x=element_blank())
  
  print(fig1 + fig2)
  
  title <- formula(mod)[3]
  title <- gsub("trial_outcome", "Mismatch", title)
  title <- gsub("component_score", 
                paste("PC", pc, " score", sep=""), 
                title)
  title <- gsub("association_strength", "Strength", title)
  title <- gsub(":", " x ", title)
  tidy(mod, effects = "fixed", conf.int = T, conf.level = 0.95) %>% 
    mutate(CI = paste0("[", 
                       sprintf("%.03f", conf.low), 
                       ", ", 
                       sprintf("%.03f", conf.high), 
                       "]", 
                       sep="")) %>% 
    select(term, estimate, CI, p.value, std.error, df) %>% 
    rename("Estimate" = estimate,
           "p-value" = p.value,
           "SE" = std.error,
           "DF" = df
    ) %>% 
    mutate(term = gsub("trial_outcomeMismatch", "Mismatch", term),
           term = gsub("component_score", 
                       paste("PC", pc, " score", sep=""), 
                       term),
           term = gsub("association_strengthWeak \\(1x\\)", "Strength", term),
           term = gsub(":", " x ", term)) %>% 
    kable(caption=paste("RT ~ ", title, sep=""),
          digits=3) %>% 
    kable_styling() %>% 
    cat()
  
  tidy(mod, effects = "ran_pars", scales = "vcov") %>% 
    select(term, estimate) %>% 
    mutate(term = gsub("var__", "Variance ", term),
           term = gsub("cov__", "Covariance ", term),
           term = gsub("\\(Intercept\\)", "intercept", term),
           term = gsub("is_mismatch", "Mismatch", term),
           term = gsub("is_incorrect", "Accuracy", term),
           term = gsub("association_strengthWeak \\(1x\\)", "Strength", term),
           term = gsub("\\.", ", ", term)) %>% 
    kable(digits=3, caption="Random effects") %>% 
    kable_styling() %>% 
    cat()
  
  slopes <- emtrends(mod, pairwise ~ association_strength * trial_outcome, var = "component_score")
  
  print("Degrees-of-freedom method: asymptotic P value adjustment: tukey method for comparing a family of 4 estimates")
  
  tidy(slopes$emtrends, conf.int = T, conf.level = 0.95) %>% 
    kable(caption=paste("slopes: RT ~ ", title, sep=""),
          digits=3) %>% 
    kable_styling() %>% 
    cat()
  
  tidy(slopes$contrasts, conf.int = T, conf.level = 0.95) %>% 
    select(contrast, estimate, std.error, df, conf.low, conf.high, statistic, adj.p.value) %>% 
    kable(caption=paste("slope contrasts: RT ~ ", title, sep=""),
          digits=3) %>% 
    kable_styling() %>% 
    cat()
  
}
```

```{r asso_pcs, echo=F}

mod <- subj.data.scores %>% 
  select(-component_orig, -value, -percent_var_explained) %>% 
  pivot_wider(names_from = component,
              values_from = component_score) %>% 
  lmer(PC3 ~ (PC1 + PC2 + PC4 + PC5 + PC6) * trial_outcome * association_strength + 
         (PC1 + PC2 + PC4 + PC5 + PC6 | subjectId),
       # (1 | expId) + (1 | expId:room_setup),
       data = .) 

tidy(mod, effects = "fixed", conf.int = T, conf.level = 0.95) %>% 
  select(term, estimate, conf.low, conf.high, p.value, std.error, df) %>% 
  kable(digits=3) %>% 
  kable_styling()

tidy(mod, effects = "ran_pars", scales = "vcov") %>% 
  select(term, estimate) %>% 
  kable(digits=3, caption="Random effects") %>% 
  kable_styling()

mod %>% 
  summary()

```


## Joint plots

```{r pull_stats, echo=F}
### stats

# row 2
emm.strength <- data.frame(
  contrast = character(),
  estimate = numeric(),
  SE = numeric(),
  df = numeric(),
  z.ratio = numeric(),
  p.value = numeric(),
  is_incorrect = numeric(),
  is_mismatch = numeric(),
  group1 = numeric(),
  group2 = numeric(),
  trial_outcome = character(),
  component = character()
)

for (i in 1:ncomp) {
  mod <- models[[i]]
  emm <- emmeans(mod, ~ is_mismatch * is_incorrect * association_strength)
  contrasts <- c("is_mismatch0 is_incorrect0 Strong (4x) - is_mismatch0 is_incorrect0 Weak (1x)",
                 "is_mismatch1 is_incorrect0 Strong (4x) - is_mismatch1 is_incorrect0 Weak (1x)")
  
  emm.strength <- as.data.frame(pairs(emm)) %>%
    dplyr::filter(contrast %in% contrasts) %>%
    mutate(component = paste("PC", i, sep="")) %>%
    mutate(trial_outcome = case_when(contrast == contrasts[1] ~ "Match",
                                     contrast == contrasts[2] ~ "Mismatch")) %>%
    mutate(group1 = 1,
           group2 = NA) %>%
    mutate(is_incorrect = NA,
           is_mismatch = NA) %>%
    select(all_of(emm.strength %>% colnames())) %>% 
    rbind(emm.strength)
  
  emm <- emmeans(mod, ~ is_mismatch * association_strength | is_incorrect)
  contrasts <- c("(is_mismatch0 Strong (4x) - is_mismatch0 Weak (1x)) - (is_mismatch1 Strong (4x) - is_mismatch1 Weak (1x))")
  
  emm.strength <- as.data.frame(pairs(pairs(emm))) %>%
    dplyr::filter(is_incorrect == 0,
                  contrast %in% contrasts) %>%
    mutate(component = paste("PC", i, sep="")) %>%
    mutate(group1 = "Match",
           group2 = "Mismatch",
           is_mismatch = NA,
           trial_outcome = "Match") %>% # dummy?
    select(all_of(emm.strength %>% colnames())) %>% 
    rbind(emm.strength)
  
}

emm.strength <- emm.strength %>% 
  mutate(across(component, 
                factor, 
                levels=ordered_pcs)) %>% 
  mutate(p.signif = case_when(p.value < 0.001 ~ "***",
                              p.value < 0.01 ~ "**",
                              p.value < 0.05 ~ "*",
                              p.value < 0.1 ~ "~")) # %>% 
# dplyr::filter(!is.na(p.signif))

# row 3
emm.match <- data.frame(
  contrast = character(),
  estimate = numeric(),
  SE = numeric(),
  df = numeric(),
  z.ratio = numeric(),
  p.value = numeric(),
  is_incorrect = numeric(),
  is_mismatch = numeric(),
  group1 = numeric(),
  group2 = numeric(),
  trial_outcome = character(),
  association_strength = character(),
  component = character()
)

for (i in 1:ncomp) {
  mod <- models[[i]]
  emm <- emmeans(mod, ~ is_mismatch * is_incorrect * association_strength)
  contrasts <- c("is_mismatch0 is_incorrect0 Strong (4x) - is_mismatch1 is_incorrect0 Strong (4x)",
                 "is_mismatch0 is_incorrect0 Weak (1x) - is_mismatch1 is_incorrect0 Weak (1x)")
  
  emm.match <- as.data.frame(pairs(emm)) %>%
    dplyr::filter(contrast %in% contrasts) %>%
    mutate(component = paste("PC", i, sep="")) %>%
    mutate(association_strength = case_when(contrast == contrasts[1] ~ "Strong (4x)",
                                            contrast == contrasts[2] ~ "Weak (1x)")) %>%
    mutate(group1 = 1,
           group2 = NA) %>%
    mutate(is_incorrect = NA,
           is_mismatch = NA,
           trial_outcome = "Mismatch - Match") %>%
    select(all_of(emm.match %>% colnames())) %>% 
    rbind(emm.match)
  
  emm <- emmeans(mod, ~ is_mismatch * association_strength | is_incorrect)
  contrasts <- c("(is_mismatch0 Strong (4x) - is_mismatch1 Strong (4x)) - (is_mismatch0 Weak (1x) - is_mismatch1 Weak (1x))")
  
  emm.match <- as.data.frame(pairs(pairs(emm))) %>%
    dplyr::filter(is_incorrect == 0,
                  contrast %in% contrasts) %>%
    mutate(component = paste("PC", i, sep="")) %>%
    mutate(group1 = "Strong (4x)",
           group2 = "Weak (1x)",
           is_mismatch = NA,
           association_strength = "Strong (4x)", # dummy
           trial_outcome = "Mismatch - Match") %>% 
    select(all_of(emm.match %>% colnames())) %>% 
    rbind(emm.match)
  
}

emm.match <- emm.match %>% 
  mutate(across(component, 
                factor, 
                levels=ordered_pcs)) %>% 
  mutate(p.signif = case_when(p.value < 0.001 ~ "***",
                              p.value < 0.01 ~ "**",
                              p.value < 0.05 ~ "*",
                              p.value < 0.1 ~ "~"))

# row 4
emm.accuracy <- data.frame(
  contrast = character(),
  estimate = numeric(),
  SE = numeric(),
  df = numeric(),
  z.ratio = numeric(),
  p.value = numeric(),
  is_incorrect = numeric(),
  is_mismatch = numeric(),
  group1 = numeric(),
  group2 = numeric(),
  trial_outcome = character(),
  association_strength = character(),
  component = character()
)

int_row4 <- data.frame(
  model_term = character(),
  df1 = numeric(),
  df2 = numeric(),
  F.ratio = numeric(),
  Chisq = numeric(),
  p.value = numeric(),
  group1 = character(),
  group2 = character()
)

for (i in 1:ncomp) {
  mod <- models[[i]]
  emm <- emmeans(mod, ~ is_mismatch * is_incorrect * association_strength)
  contrasts <- c("is_mismatch0 is_incorrect0 Strong (4x) - is_mismatch0 is_incorrect1 Strong (4x)",
                 "is_mismatch0 is_incorrect0 Weak (1x) - is_mismatch0 is_incorrect1 Weak (1x)",
                 "is_mismatch1 is_incorrect0 Strong (4x) - is_mismatch1 is_incorrect1 Strong (4x)",
                 "is_mismatch1 is_incorrect0 Weak (1x) - is_mismatch1 is_incorrect1 Weak (1x)")
  
  emm.accuracy <- as.data.frame(pairs(emm)) %>%
    dplyr::filter(contrast %in% contrasts) %>%
    mutate(component = paste("PC", i, sep="")) %>%
    mutate(trial_outcome = case_when(contrast == contrasts[1] ~ "Hit - Miss",
                                     contrast == contrasts[2] ~ "Hit - Miss",
                                     contrast == contrasts[3] ~ "CR - FA",
                                     contrast == contrasts[4] ~ "CR - FA")) %>%
    mutate(association_strength = case_when(contrast == contrasts[1] ~ "Strong (4x)",
                                            contrast == contrasts[2] ~ "Weak (1x)",
                                            contrast == contrasts[3] ~ "Strong (4x)",
                                            contrast == contrasts[4] ~ "Weak (1x)")) %>%
    mutate(group1 = 1,
           group2 = NA) %>%
    mutate(is_incorrect = NA,
           is_mismatch = NA) %>%
    select(all_of(emm.accuracy %>% colnames())) %>% 
    rbind(emm.accuracy)
  
  emm <- emmeans(mod, ~ is_incorrect * association_strength | is_mismatch)
  contrasts <- c("(is_incorrect0 Strong (4x) - is_incorrect1 Strong (4x)) - (is_incorrect0 Weak (1x) - is_incorrect1 Weak (1x))",
                 "(is_incorrect0 Strong (4x) - is_incorrect1 Strong (4x)) - (is_incorrect0 Weak (1x) - is_incorrect1 Weak (1x))")
  
  emm.accuracy <- as.data.frame(pairs(pairs(emm))) %>%
    dplyr::filter(contrast %in% contrasts) %>%
    mutate(trial_outcome = if_else(is_mismatch == 1, "CR - FA", "Hit - Miss")) %>% 
    mutate(component = paste("PC", i, sep="")) %>%
    mutate(group1 = "Hit - Miss",
           group2 = "CR - FA",
           is_incorrect = NA,
           association_strength = "Strong (4x)") %>% # dummy
    select(all_of(emm.accuracy %>% colnames())) %>% 
    rbind(emm.accuracy)
  
  int_row4 <- as.data.frame(joint_tests(mod)) %>% 
    dplyr::filter(`model term` == "is_mismatch:is_incorrect:association_strength") %>% 
    rename(model_term = `model term`) %>% 
    mutate(component = paste("PC", i, sep="")) %>%
    mutate(group1 = "Hit - Miss",
           group2 = "CR - FA") %>% 
    rbind(int_row4)
}

emm.accuracy <- emm.accuracy %>% 
  mutate(across(component, 
                factor, 
                levels=ordered_pcs)) %>% 
  mutate(p.signif = case_when(p.value < 0.001 ~ "***",
                              p.value < 0.01 ~ "**",
                              p.value < 0.05 ~ "*",
                              p.value < 0.1 ~ "~")) # %>% 
# dplyr::filter(!is.na(p.signif))

int_row4 <- int_row4 %>% 
  mutate(across(component, 
                factor, 
                levels=ordered_pcs)) %>% 
  mutate(association_strength = "Strong (4x)") %>% # dummy
  mutate(p.signif = case_when(p.value < 0.001 ~ "***",
                              p.value < 0.01 ~ "**",
                              p.value < 0.05 ~ "*",
                              p.value < 0.1 ~ "~")) # %>% 
# dplyr::filter(!is.na(p.signif))

###
```


```{r plot_all, echo=F, fig.width=12, fig.height=10}
loadings.hrz.plt <- pca.loadings %>% 
  mutate(component = paste(component, ": ", round(percent_var_explained, 2),
                           "%",
                           sep = "")) %>% 
  mutate(across(component,
                factor,
                levels=component_order_with_var_explained)) %>%
  ggplot(aes(x = time, 
             y = loading,
             color = component,
             fill = component)) +
  geom_vline(xintercept = c(0, 1, 2, 2.75),
             linetype = "dashed",
             color = "gray37") +
  geom_line(color="black", linewidth=1) +
  geom_text(aes(label = event,
                x = time,
                y = 0.75),
            data = ret_labels,
            inherit.aes = FALSE,
            angle = 90, 
            hjust = 1,
            vjust = 1.2,
            size = 3,
            colour = "gray37",
            family = fontfamily) + 
  facet_wrap(~component, nrow=1) +
  labs(x = "Time (s)",
       y = "PC loading") +
  scale_color_brewer(palette="Set2") + 
  scale_fill_brewer(palette="Set2") +
  theme(legend.position = "none")

scores.hrz.plt <- subj.data.scores %>% 
  mutate(across(trial_outcome, 
                factor, 
                levels=c("Hit", "CR", "Miss", "FA"))) %>%
  # mutate(across(association_strength, 
  #               factor, 
  #               levels=c("Weak (1x)", "Strong (4x)"))) %>%
  mutate(across(component, 
                factor, 
                levels=ordered_pcs)) %>% 
  group_by(subjectId, association_strength, trial_outcome, component) %>% 
  summarize(component_score = mean(component_score)) %>% 
  summarySEwithin(., 
                  measurevar="component_score", 
                  withinvars=c("association_strength",
                               "trial_outcome",
                               "component"), 
                  idvar="subjectId") %>% 
  ggplot(aes(x = association_strength,
             y = component_score,
             fill = trial_outcome)) +
  stat_summary(fun = "mean", 
               geom = "bar", 
               color = "black", 
               position=position_dodge()) +
  geom_errorbar(aes(ymin=component_score-se, ymax=component_score+se),
                position=position_dodge(.9), 
                width=.2) +
  facet_wrap(~component, scales = "free", nrow=1) +
  scale_color_manual(values=c("#1a75ff", "#ff751a", "#80b3ff", "#ffb380"), name="") +
  scale_fill_manual(values=c("#1a75ff", "#ff751a", "#80b3ff", "#ffb380"), name="") +
  labs(x = "", y = "PC score")
```

```{r long_version, echo=F, fig.width=8, fig.height=8}
loadings.vrt.plt <- pca.loadings %>% 
  mutate(component = paste(component, ": ", round(percent_var_explained, 2),
                           "%",
                           sep = "")) %>% 
  mutate(across(component,
                factor,
                levels=component_order_with_var_explained)) %>%
  ggplot(aes(x = time, 
             y = loading,
             color = component,
             fill = component)) +
  geom_vline(xintercept = c(0, 1, 2, 2.75),
             linetype = "dashed",
             color = "gray37") +
  geom_line(color="black", linewidth=1) +
  geom_text(aes(label = event,
                x = time,
                y = 0.75),
            data = ret_labels,
            inherit.aes = FALSE,
            angle = 90, 
            hjust = 1,
            vjust = 1.2,
            size = 3,
            colour = "gray37",
            family = fontfamily) + 
  facet_wrap(~component, ncol=1) +
  labs(x = "Time (s)",
       y = "PC loading") +
  theme(legend.position = "none")

scores.vrt.plt <- subj.data.scores %>% 
  mutate(trial_outcome = recode(trial_outcome, 
                                "Hit" = "Match",
                                "CR" = "Mismatch")) %>% 
  mutate(across(trial_outcome, 
                factor, 
                levels=c("Match", "Mismatch", "Miss", "FA"))) %>%
  # mutate(across(association_strength, 
  #               factor, 
  #               levels=c("Weak (1x)", "Strong (4x)"))) %>%
  mutate(across(component, 
                factor, 
                levels=ordered_pcs)) %>% 
  group_by(subjectId, association_strength, trial_outcome, component) %>% 
  summarize(component_score = mean(component_score)) %>% 
  summarySEwithin(., 
                  measurevar="component_score", 
                  withinvars=c("association_strength",
                               "trial_outcome",
                               "component"), 
                  idvar="subjectId") %>% 
  ggplot(aes(x = association_strength,
             y = component_score,
             fill = trial_outcome)) +
  stat_summary(fun = "mean", 
               geom = "bar", 
               color = "black", 
               position=position_dodge()) +
  geom_errorbar(aes(ymin=component_score-se, ymax=component_score+se),
                position=position_dodge(.9), 
                width=.2) +
  facet_grid(rows=vars(component), 
             cols=vars(association_strength), 
             scales = "free") +
  scale_color_manual(values=c("#1a75ff", "#ff751a", "#80b3ff", "#ffb380"), name="") +
  scale_fill_manual(values=c("#1a75ff", "#ff751a", "#80b3ff", "#ffb380"), name="") +
  labs(x = "", y = "PC score") +
  theme(
    strip.text.y = element_blank(),
    axis.text.x=element_blank(),
    axis.ticks.x=element_blank())


rt.binned.plt <- rt_data %>% 
  # mutate(across(association_strength, 
  #                 factor, 
  #                 levels=c("Weak (1x)", "Strong (4x)"))) %>% 
  group_by(subjectId, component, association_strength, trial_outcome) %>%
  mutate(trial_count = n()) %>%
  ungroup() %>%
  dplyr::filter(trial_count > nbins-1) %>%
  group_by(subjectId, component, association_strength, trial_outcome) %>% 
  mutate(component_score_bin = cut_interval(component_score, 
                                            n = nbins,
                                            labels = F)) %>% 
  ungroup() %>% 
  group_by(subjectId, trial_outcome, association_strength,
           component, component_score_bin) %>% 
  summarize(rt = median(match_response.rt)) %>% 
  summarySEwithin(., 
                  measurevar="rt", 
                  withinvars=c("association_strength",
                               "trial_outcome",
                               "component",
                               "component_score_bin"), 
                  idvar="subjectId") %>% 
  mutate(across(component,
                factor,
                levels=ordered_pcs)) %>%
  ggplot(aes(x = as.numeric(as.character(component_score_bin)),
             y = rt,
             color = trial_outcome,
             group = trial_outcome)) +
  geom_line(linewidth=0.8) +
  geom_point(size=1.5) +
  geom_errorbar(aes(ymin=rt-se, ymax=rt+se),
                width=0.2) +
  facet_grid(rows=vars(component), 
             cols=vars(association_strength),
             axes="all_x",
             scales = "free") +
  scale_color_manual(values=c("#1a75ff", "#ff751a"), name="") +
  scale_fill_manual(values=c("#1a75ff", "#ff751a"), name="") +
  labs(x = "PC score quartile", y = "RT (s)") +
  theme(strip.text.y = element_blank())

loadings.vrt.plt + scores.vrt.plt + rt.binned.plt +
  plot_layout(widths=c(1,2,2), 
              guides="collect", axes = "collect", axis_titles = "collect") &
  theme(
    text = element_text(size = 10)
  )

```


```{r difference, echo=F, fig.width=10, fig.height=9}

diff.strength.plt <- subj.data.scores %>% 
  mutate(trial_outcome = as.character(trial_outcome)) %>% 
  dplyr::filter(trial_outcome %in% c("Hit", "CR")) %>% 
  mutate(trial_outcome=replace(trial_outcome, trial_outcome=="Hit", "Match")) %>%
  mutate(trial_outcome=replace(trial_outcome, trial_outcome=="CR", "Mismatch")) %>%
  mutate(across(component, 
                factor, 
                levels=ordered_pcs)) %>% 
  group_by(subjectId, association_strength, trial_outcome, component) %>% 
  summarize(component_score = mean(component_score)) %>% 
  pivot_wider(names_from="association_strength", 
              values_from=c("component_score")) %>% 
  mutate(strong_minus_weak = `Strong (4x)` - `Weak (1x)`) %>%
  select(-`Strong (4x)`, -`Weak (1x)`) %>% 
  rename(component_score = strong_minus_weak) %>% 
  summarySEwithin(., 
                  na.rm=T,
                  measurevar="component_score", 
                  withinvars=c("trial_outcome",
                               "component"), 
                  idvar="subjectId") %>% 
  ggplot(aes(x = trial_outcome,
             y = component_score,
             fill = trial_outcome)) +
  stat_summary(fun = "mean", 
               geom = "bar", 
               color = "black",
               position=position_dodge()) +
  geom_errorbar(aes(ymin=component_score-se, ymax=component_score+se),
                position=position_dodge(.9), 
                width=.2) +
  labs(title = "Strong - Weak", 
       x = "",
       y = "PC score difference") +
  facet_wrap(~component, nrow=1) + 
  scale_color_manual(values=c("#1a75ff", "#ff751a"), name="") +
  scale_fill_manual(values=c("#1a75ff", "#ff751a"), name="") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

diff.data <- subj.data.scores %>% 
  mutate(trial_outcome = recode(trial_outcome, 
                                "Hit" = "Match",
                                "CR" = "Mismatch")) %>% 
  mutate(across(trial_outcome, 
                factor, 
                levels=c("Match", "Mismatch", "Miss", "FA"))) %>%
  mutate(across(component, 
                factor, 
                levels=ordered_pcs)) %>% 
  group_by(subjectId, association_strength, trial_outcome, component) %>% 
  summarize(component_score = mean(component_score)) %>% 
  pivot_wider(names_from="trial_outcome", 
              values_from=c("component_score")) %>% 
  mutate(mismatch_minus_match = Mismatch - Match) %>% 
  pivot_longer(cols = c("Match", "Miss", "Mismatch", "FA", "mismatch_minus_match"),
               names_to = "trial_outcome",
               values_to = "component_score") %>% 
  dplyr::filter(trial_outcome == "mismatch_minus_match") %>% 
  mutate(trial_outcome = replace(trial_outcome, 
                                 trial_outcome == "mismatch_minus_match",
                                 "Mismatch - Match"))

diff.match.plt <- diff.data %>%
  summarySEwithin(., 
                  na.rm=T,
                  measurevar="component_score", 
                  withinvars=c("association_strength",
                               "trial_outcome",
                               "component"), 
                  idvar="subjectId") %>% 
  ggplot(aes(x = association_strength,
             y = component_score,
             fill = association_strength)) +
  stat_summary(fun = "mean", 
               geom = "bar", 
               color = "black", 
               position=position_dodge()) +
  geom_errorbar(aes(ymin=component_score-se, ymax=component_score+se),
                position=position_dodge(.9), 
                width=.2) +
  labs(title = "Mismatch - Match", 
       x = "",
       y = "PC score difference") +
  facet_wrap(~component, nrow=1) + 
  scale_color_manual(values=palette, name="") + 
  scale_fill_manual(values=palette, name="") + 
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

diff.mem.data <- subj.data.scores %>% 
  mutate(across(component, 
                factor, 
                levels=ordered_pcs)) %>% 
  group_by(subjectId, association_strength, trial_outcome, component) %>% 
  summarize(component_score = mean(component_score)) %>% 
  pivot_wider(names_from="trial_outcome", 
              values_from=c("component_score")) %>% 
  mutate(hit_minus_miss = Hit - Miss,
         cr_minus_fa = CR - FA) %>% 
  pivot_longer(cols = c("hit_minus_miss", "cr_minus_fa"),
               names_to = "trial_outcome",
               values_to = "component_score") %>% 
  mutate(trial_outcome = replace(trial_outcome, 
                                 trial_outcome == "cr_minus_fa",
                                 "CR - FA")) %>%  
  mutate(trial_outcome = replace(trial_outcome, 
                                 trial_outcome == "hit_minus_miss",
                                 "Hit - Miss")) %>%
  mutate(across(trial_outcome, 
                factor, 
                levels=c("Hit - Miss", "CR - FA")))

diff.mem.plt <- diff.mem.data %>%
  summarySEwithin(., 
                  na.rm=T,
                  measurevar="component_score", 
                  withinvars=c("association_strength",
                               "trial_outcome",
                               "component"), 
                  idvar="subjectId") %>% 
  ggplot(aes(x = trial_outcome,
             y = component_score,
             fill = association_strength)) +
  stat_summary(fun = "mean", 
               geom = "bar", 
               color = "black", 
               position=position_dodge()) +
  geom_errorbar(aes(ymin=component_score-se, ymax=component_score+se),
                position=position_dodge(.9), 
                width=.2) +
  facet_wrap(~component, nrow=1) + 
  labs(title = "Correct - Incorrect",
       x = "", 
       y = "PC score difference") + 
  scale_color_manual(values=palette, name="") + 
  scale_fill_manual(values=palette, name="") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

design <- "
  11111
  11111
  22222
  22222
  22222
  22222
  22222
  22222
  22222
  22222
"

row2.plt <- diff.strength.plt + 
  stat_pvalue_manual(emm.strength %>% 
                       dplyr::filter(is.na(group2)), 
                     x = "trial_outcome", 
                     y.position = 0.39, 
                     label = "p.signif") + 
  stat_pvalue_manual(emm.strength %>% 
                       dplyr::filter(!is.na(group2)), 
                     tip.length = 0.02, 
                     y.position = 0.50, 
                     label = "p.signif") + 
  theme(
    axis.title.x=element_blank(),
    axis.text.x=element_blank(),
    axis.ticks.x=element_blank())

row3.plt <- diff.match.plt +
  stat_pvalue_manual(emm.match %>% 
                       dplyr::filter(is.na(group2)), 
                     x = "association_strength", 
                     y.position = 0.40, 
                     label = "p.signif",
                     position = position_dodge(0.9)) + 
  stat_pvalue_manual(emm.match %>% 
                       dplyr::filter(!is.na(group2)), 
                     tip.length = 0.02, 
                     y.position = 0.48, 
                     label = "p.signif",
                     position = position_dodge(0.9)) + 
  theme(
    axis.title.x=element_blank(),
    axis.text.x=element_blank(),
    axis.ticks.x=element_blank())

row4.plt <- diff.mem.plt + 
  stat_pvalue_manual(emm.accuracy %>% 
                       dplyr::filter(is.na(group2)), 
                     x = "trial_outcome", 
                     y.position = 0.58, 
                     label = "p.signif",
                     position = position_dodge(0.9)) + 
  stat_pvalue_manual(emm.accuracy %>% 
                       dplyr::filter(!is.na(group2)), # %>% 
                     #mutate(x = "trial_outcome"), 
                     x = "trial_outcome",
                     tip.length = 0.02, 
                     y.position = 0.76, 
                     label = "p.signif",
                     position = position_dodge(0.9)) +
  stat_pvalue_manual(int_row4,
                     tip.length = 0.02, 
                     y.position = 1, 
                     label = "p.signif") + 
  theme(
    axis.title.x=element_blank(),
  )


combined_diff_plot <- (row2.plt / row3.plt / row4.plt) + 
  plot_layout(guides = "collect", axes = "collect", axis_titles = "collect_y") &
  theme(
    strip.text = element_blank()
  )

final_plot <- loadings.hrz.plt + 
  combined_diff_plot + 
  plot_layout(design = design,
              guides = "collect", 
              axes = "collect", 
              axis_titles = "collect") &
  theme(plot.title = element_text(size=12))

final_plot

```


## Individual PC plots

```{r indivi_pc_plots, fig.width=6, fig.height=2, echo=F}

showtext_opts(dpi = 300)
for (pc in 1:ncomp) {
  fig1 <- pca.loadings %>% 
    dplyr::filter(component == paste("PC", pc, sep="")) %>% 
    mutate(component = paste(component, ": ", round(percent_var_explained, 2),
                             "%",
                             sep = "")) %>% 
    ggplot(aes(x = time, 
               y = loading,
               color = component,
               fill = component)) +
    geom_vline(xintercept = c(0, 1, 2, 2.75),
               linetype = "dashed",
               color = "gray37") +
    geom_line(color="black", linewidth=1) +
    geom_text(aes(label = event,
                  x = time,
                  y = 0.75),
              data = ret_labels,
              inherit.aes = FALSE,
              angle = 90, 
              hjust = 1,
              vjust = 1.2,
              size = 3,
              colour = "gray37",
              family = fontfamily) + 
    facet_wrap(~component) +
    ylim(-0.25, 1) +
    labs(x = "Time (s)",
         y = "PC loading") +
    scale_color_brewer(palette="Set2") + 
    scale_fill_brewer(palette="Set2") +
    theme(legend.position = "none")
  
  fig2 <- subj.data.scores %>% 
    dplyr::filter(component == paste("PC", pc, sep="")) %>% 
    mutate(across(trial_outcome, 
                  factor, 
                  levels=c("Hit", "CR", "Miss", "FA"))) %>%
    group_by(subjectId, association_strength, trial_outcome, component) %>% 
    summarize(component_score = mean(component_score)) %>% 
    summarySEwithin(., 
                    measurevar="component_score", 
                    withinvars=c("association_strength",
                                 "trial_outcome",
                                 "component"), 
                    idvar="subjectId") %>% 
    ggplot(aes(x = exp_id,
               y = component_score,
               fill = trial_outcome)) +
    stat_summary(fun = "mean", 
                 geom = "bar", 
                 color = "black", 
                 position=position_dodge()) +
    geom_errorbar(aes(ymin=component_score-se, ymax=component_score+se),
                  position=position_dodge(.9), 
                  width=.2) +
    facet_grid(cols=vars(association_strength), 
               rows=vars(component)) +
    scale_color_manual(values=c("#1a75ff", "#ff751a", "#80b3ff", "#ffb380"), name="") +
    scale_fill_manual(values=c("#1a75ff", "#ff751a", "#80b3ff", "#ffb380"), name="") +
    labs(x = "", y = "PC score") + 
    theme(axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank())
  
  fig3 <- rt_data %>% 
    dplyr::filter(component == paste("PC", pc, sep="")) %>% 
    group_by(subjectId, component, association_strength, trial_outcome) %>%
    # exclude any subjects with # trials < # bins
    mutate(trial_count = n()) %>%
    ungroup() %>%
    dplyr::filter(trial_count > nbins-1) %>%
    group_by(subjectId, component, association_strength, trial_outcome) %>% 
    mutate(component_score_bin = cut_interval(component_score, 
                                              n = nbins,
                                              labels = F)) %>% 
    ungroup() %>% 
    group_by(subjectId, trial_outcome, association_strength,
             component, component_score_bin) %>% 
    summarize(rt = median(match_response.rt)) %>% 
    summarySEwithin(., 
                    measurevar="rt", 
                    withinvars=c("association_strength",
                                 "trial_outcome",
                                 "component",
                                 "component_score_bin"), 
                    idvar="subjectId") %>% 
    mutate(across(component,
                  factor,
                  levels=ordered_pcs)) %>%
    ggplot(aes(x = as.numeric(as.character(component_score_bin)),
               y = rt,
               color = trial_outcome,
               group = trial_outcome)) +
    geom_line(linewidth=0.8) +
    geom_point(size=1.5) +
    geom_errorbar(aes(ymin=rt-se, ymax=rt+se),
                  width=0.2) +
    facet_grid(cols=vars(association_strength), 
               rows=vars(component)) +
    scale_color_manual(values=c("#1a75ff", "#ff751a"), name="") +
    scale_fill_manual(values=c("#1a75ff", "#ff751a"), name="") +
    labs(x = "PC score quartile", y = "RT (s)") +
    guides(color = "none")
  
  joint.fig <- (fig1 + fig2 + fig3) +
    plot_layout(widths=c(1,1,1), 
                guides="collect", axis_titles = "collect") &
    theme(strip.text.x = element_text(size=12),
          strip.text.y = element_blank(),
          strip.background = element_blank(),
          text = element_text(size = 10),
    )
  
  joint.fig %>% 
    print()
  
  ggsave(paste("tPCA_figures/PC", pc, "_scores_and_RT.pdf", sep=""),
         plot=joint.fig,
         width=22, 
         height=7, 
         dpi=300,
         create.dir=T,
         units="cm")
}
showtext_opts(op)

```


```{r other_version_of_pc_plots, fig.width=6, fig.height=2, echo=F}

showtext_opts(dpi = 300)
for (pc in 1:ncomp) {
  fig1 <- pca.loadings %>% 
    dplyr::filter(component == paste("PC", pc, sep="")) %>% 
    ggplot(aes(x = time, 
               y = loading,
               color = component,
               fill = component)) +
    geom_vline(xintercept = c(0, 1, 2, 2.75),
               linetype = "dashed",
               color = "gray37") +
    geom_line(color="black", linewidth=1) +
    geom_text(aes(label = event,
                  x = time,
                  y = 0.75),
              data = ret_labels,
              inherit.aes = FALSE,
              angle = 90, 
              hjust = 1,
              vjust = 1.2,
              size = 3,
              colour = "gray37",
              family = fontfamily) + 
    facet_wrap(~component) +
    ylim(-0.25, 1) +
    labs(x = "Time (s)",
         y = "PC loading") +
    scale_color_brewer(palette="Set2") + 
    scale_fill_brewer(palette="Set2") +
    theme(legend.position = "none",
          strip.text.x = element_text(size=12),
          strip.background = element_blank())
  
  fig2 <- subj.data.scores %>% 
    dplyr::filter(component == paste("PC", pc, sep="")) %>% 
    mutate(across(trial_outcome, 
                  factor, 
                  levels=c("Hit", "CR", "Miss", "FA"))) %>%
    group_by(subjectId, association_strength, trial_outcome, component) %>% 
    summarize(component_score = mean(component_score)) %>% 
    summarySEwithin(., 
                    measurevar="component_score", 
                    withinvars=c("association_strength",
                                 "trial_outcome",
                                 "component"), 
                    idvar="subjectId") %>% 
    ggplot(aes(x = exp_id,
               y = component_score,
               fill = trial_outcome)) +
    stat_summary(fun = "mean", 
                 geom = "bar", 
                 color = "black", 
                 position=position_dodge()) +
    geom_errorbar(aes(ymin=component_score-se, ymax=component_score+se),
                  position=position_dodge(.9), 
                  width=.2) +
    facet_grid(cols=vars(association_strength), 
               rows=vars(component)) +
    scale_color_manual(values=c("#1a75ff", "#ff751a", "#80b3ff", "#ffb380"), name="") +
    scale_fill_manual(values=c("#1a75ff", "#ff751a", "#80b3ff", "#ffb380"), name="") +
    labs(x = "", y = "PC score") + 
    theme(axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank())
  
  fig3 <- rt_data %>% 
    dplyr::filter(component == paste("PC", pc, sep="")) %>% 
    group_by(subjectId, component, association_strength, trial_outcome) %>%
    # exclude any subjects with # trials < # bins
    mutate(trial_count = n()) %>%
    ungroup() %>%
    dplyr::filter(trial_count > nbins-1) %>%
    group_by(subjectId, component, association_strength, trial_outcome) %>% 
    mutate(component_score_bin = cut_interval(component_score, 
                                              n = nbins,
                                              labels = F)) %>% 
    ungroup() %>% 
    group_by(subjectId, trial_outcome, association_strength,
             component, component_score_bin) %>% 
    summarize(rt = median(match_response.rt)) %>% 
    summarySEwithin(., 
                    measurevar="rt", 
                    withinvars=c("association_strength",
                                 "trial_outcome",
                                 "component",
                                 "component_score_bin"), 
                    idvar="subjectId") %>% 
    mutate(across(component,
                  factor,
                  levels=ordered_pcs)) %>%
    ggplot(aes(x = as.numeric(as.character(component_score_bin)),
               y = rt,
               color = trial_outcome,
               group = trial_outcome)) +
    geom_line(linewidth=0.8) +
    geom_point(size=1.5) +
    geom_errorbar(aes(ymin=rt-se, ymax=rt+se),
                  width=0.2) +
    facet_grid(cols=vars(association_strength), 
               rows=vars(component)) +
    scale_color_manual(values=c("#1a75ff", "#ff751a"), name="") +
    scale_fill_manual(values=c("#1a75ff", "#ff751a"), name="") +
    labs(x = "PC score quartile", y = "RT (s)") +
    guides(color = "none")
  
  joint.fig <- (fig1 + fig2 + fig3) +
    plot_layout(widths=c(1,1,1), 
                guides="collect", axis_titles = "collect") &
    theme(strip.text.y = element_blank()
    )
  
  joint.fig %>% 
    print()
  
  ggsave(paste("tPCA_figures/PC", pc, "_scores_and_RT_framed.pdf", sep=""),
         plot=joint.fig,
         width=23, 
         height=7, 
         dpi=300,
         create.dir=T,
         units="cm")
}
showtext_opts(op)

```

## Subsequent memory - CR trials

```{r submem_hist, echo=F, eval=T}
palette <- c("#59735e", "#b7c8ba")

subj.data.submem <- subj.data.scores %>% 
  left_join(recognition_behavior,
            by = c("subjectId", "expId", "img"),
            suffix = c(".retrieval", ".recognition")) %>%
  dplyr::filter(!is.na(trial_outcome.recognition)) %>% 
  dplyr::filter(trial_outcome.retrieval == "CR") %>% 
  mutate(across(trial_outcome.recognition, 
                factor, 
                levels=c("Hit", "Miss")))

subj.data.submem %>% 
  dplyr::filter(component == "PC1") %>% 
  group_by(subjectId, association_strength, trial_outcome.recognition) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  complete(subjectId, association_strength, trial_outcome.recognition) %>% 
  mutate(n = ifelse(is.na(n), 0, n)) %>% 
  ggplot(aes(x=n)) +
  geom_histogram() +
  facet_grid(rows=vars(association_strength),
             cols=vars(trial_outcome.recognition)) +
  labs(x="Trial count",
       y="N subjects")

subj.data.submem %>% 
  dplyr::filter(component == "PC1") %>% 
  group_by(subjectId, association_strength, trial_outcome.recognition) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  complete(subjectId, association_strength, trial_outcome.recognition) %>% 
  mutate(n = ifelse(is.na(n), 0, n)) %>% 
  dplyr::filter(n == 0) %>% 
  kable() %>% 
  kable_styling()

subj.data.submem %>% 
  dplyr::filter(component == "PC1") %>% 
  group_by(subjectId, association_strength, trial_outcome.recognition) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  complete(subjectId, association_strength, trial_outcome.recognition) %>% 
  mutate(n = ifelse(is.na(n), 0, n)) %>% 
  dplyr::filter(n == 0) %>% 
  pull(subjectId) %>% 
  unique()

subj.data.submem %>% 
  dplyr::filter(component == "PC1") %>% 
  group_by(subjectId, association_strength) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  complete(subjectId, association_strength) %>% 
  mutate(n = ifelse(is.na(n), 0, n)) %>% 
  dplyr::filter(n == 0)
```

```{r same_tempPCA_submem, echo=F, fig.width=10, fig.height=12, eval=T}

submem.plt <- subj.data.submem %>%
  group_by(subjectId, association_strength, trial_outcome.recognition, component, expId) %>% 
  summarize(component_score = mean(component_score)) %>% 
  summarySEwithin(., 
                  measurevar="component_score", 
                  withinvars=c("association_strength",
                               "trial_outcome.recognition",
                               "component"), 
                  betweenvars=c("expId"),
                  idvar="subjectId") %>% 
  mutate(across(component,
                factor,
                levels=ordered_pcs)) %>%
  ggplot(aes(x = association_strength,
             y = component_score,
             fill = trial_outcome.recognition)) +
  stat_summary(fun = "mean", 
               geom = "bar", 
               color = "black", 
               position=position_dodge()) +
  geom_errorbar(aes(ymin=component_score-se, ymax=component_score+se),
                position=position_dodge(.9), 
                width=.2) +
  scale_color_manual(values=hit_miss_palette, name="") +
  scale_fill_manual(values=hit_miss_palette, name="") +
  labs(x = "", y = "PC score") +
  theme(strip.text.y = element_blank()) + 
  facet_grid(rows = vars(component),
             cols = vars(expId))

loadings.vrt.plt + submem.plt + 
  plot_layout(widths=c(1,2,2)) 

```

### Models

```{r recog_models, echo=F, results="asis", eval=run_models}

recog.lmer.models <- list()

for (i in 1:ncomp) {
  print(paste("PC", i))
  mod.data <- subj.data.submem %>%
    dplyr::filter(component == paste("PC", i, sep=""))
  
  mod <- mod.data %>% 
    lmer(component_score ~ trial_outcome.recognition * association_strength * expId + 
           (trial_outcome.recognition * association_strength | subjectId),
         data = .)
  
  if (isSingular(mod) | any(grepl("failed to converge", mod@optinfo$conv$lme4$messages))) {
    mod <- mod.data %>% 
      lmer(component_score ~ trial_outcome.recognition * association_strength * expId + 
             (trial_outcome.recognition + association_strength + expId | subjectId),
           data = .)
  }
  
  if (isSingular(mod) | any(grepl("failed to converge", mod@optinfo$conv$lme4$messages))) {
    mod <- mod.data %>% 
      lmer(component_score ~ trial_outcome.recognition * association_strength * expId + 
             (1 | subjectId),
           data = .)
  }
  
  if (isSingular(mod) | any(grepl("failed to converge", mod@optinfo$conv$lme4$messages))) {
    print("MODEL DID NOT CONVERGE") 
  }
  
  recog.lmer.models[[i]] <- mod 
}

```

```{r show_recog_mods, echo=F, results="asis"}

for (i in 1:ncomp) {
  mod <- recog.lmer.models[[i]]
  
  tidy(mod, effects = "fixed", conf.int = T, conf.level = 0.95) %>% 
    select(term, estimate, conf.low, conf.high, p.value, std.error, df) %>% 
    kable(caption=paste("PC", i, ": ", formula(mod)[3], sep=""),
          digits=3) %>% 
    kable_styling() %>%
    cat()
  
  tidy(mod, effects = "ran_pars", scales = "vcov") %>% 
    select(term, estimate) %>% 
    kable(digits=3, caption="Random effects") %>% 
    kable_styling() %>% 
    cat()
  
  emm <- emmeans(mod, ~ trial_outcome.recognition | association_strength | expId, adjust="bonferroni")
  emm.pairs <- pairs(emm)
  tidy(emm.pairs, effects = "fixed", conf.int = T, conf.level = 0.95) %>% 
    select(expId, association_strength, contrast, estimate, conf.low, conf.high, p.value, std.error) %>% 
    kable(digits=3) %>% 
    kable_styling() %>% 
    cat()
  
}

```

## Subsequent memory RT


```{r rt_data_submem, echo=F}
### joint plot
rt_data.submem <- subj.data.submem %>%
  mutate(trial_outcome.recognition = as.character(trial_outcome.recognition)) %>% 
  dplyr::filter(trial_outcome.recognition %in% c("Hit")) %>% 
  # mutate(across(association_strength, 
  #                 factor, 
  #                 levels=c("Weak (1x)", "Strong (4x)"))) %>% 
  mutate(across(association_strength, 
                factor, 
                levels=c("Strong (4x)", "Weak (1x)")))
```

```{r submem_rt_joint_plot, echo=F, fig.width=10, fig.height=8, results="asis", eval=run_models}
models.recog.rt <- list()

for (pc in 1:ncomp) {
  mod <- rt_data.submem %>% 
    dplyr::filter(component == paste("PC", pc, sep="")) %>% 
    mutate(recognition_response.rt = log(recognition_response.rt)) %>%  
    lmer(recognition_response.rt ~ component_score * association_strength * expId + 
           (component_score * association_strength * expId | subjectId),
         data = .)
  
  if (isSingular(mod) | any(grepl("failed to converge", mod@optinfo$conv$lme4$messages))) {
    mod <- rt_data.submem %>% 
      dplyr::filter(component == paste("PC", pc, sep="")) %>% 
      mutate(recognition_response.rt = log(recognition_response.rt)) %>%  
      lmer(recognition_response.rt ~ component_score * association_strength * expId + 
             (component_score + association_strength + expId | subjectId),
           data = .)
  }
  
  if (isSingular(mod) | any(grepl("failed to converge", mod@optinfo$conv$lme4$messages))) {
    mod <- rt_data.submem %>% 
      dplyr::filter(component == paste("PC", pc, sep="")) %>% 
      mutate(recognition_response.rt = log(recognition_response.rt)) %>%  
      lmer(recognition_response.rt ~ component_score * association_strength * expId + 
             (component_score | subjectId),
           data = .)
  }
  
  if (isSingular(mod) | any(grepl("failed to converge", mod@optinfo$conv$lme4$messages))) {
    mod <- rt_data.submem %>% 
      dplyr::filter(component == paste("PC", pc, sep="")) %>% 
      mutate(recognition_response.rt = log(recognition_response.rt)) %>%  
      lmer(recognition_response.rt ~ component_score * association_strength * expId + 
             (1 | subjectId),
           data = .)
  }
  
  models.recog.rt[[pc]] <- mod
  
}


```


```{r submem.binned.rt, echo=F, fig.width=7, fig.height=10, eval=T}

nbins <- 4

rt.binned.plt <- rt_data.submem %>% 
  mutate(trial_outcome = trial_outcome.recognition) %>% 
  mutate(across(association_strength, 
                factor, 
                levels=c("Strong (4x)", "Weak (1x)"))) %>% 
  group_by(subjectId, component, association_strength, trial_outcome, expId) %>%
  mutate(trial_count = n()) %>%
  ungroup() %>%
  dplyr::filter(trial_count > nbins-1) %>%
  group_by(subjectId, component, association_strength, trial_outcome, expId) %>% 
  mutate(component_score_bin = cut_interval(component_score, 
                                            n = nbins,
                                            labels = F)) %>% 
  ungroup() %>% 
  group_by(subjectId, trial_outcome, association_strength,
           component, component_score_bin, expId) %>% 
  summarize(rt = median(recognition_response.rt)) %>% 
  summarySEwithin(., 
                  measurevar="rt", 
                  withinvars=c("association_strength",
                               "trial_outcome",
                               "component",
                               "component_score_bin"), 
                  betweenvars=c("expId"),
                  idvar="subjectId") %>% 
  mutate(across(component,
                factor,
                levels=ordered_pcs)) %>%
  ggplot(aes(x = as.numeric(as.character(component_score_bin)),
             y = rt,
             color = association_strength,
             group = association_strength)) +
  geom_line(linewidth=0.8) +
  geom_point(size=1.5) +
  geom_errorbar(aes(ymin=rt-se, ymax=rt+se),
                width=0.2) +
  facet_grid(rows=vars(component), 
             axes="all",
             scales = "free") +
  scale_color_manual(values=palette, name="") +
  scale_fill_manual(values=palette, name="") +
  labs(x = "PC score", y = "RT (s)") +
  theme(strip.text.y = element_blank()) + 
  facet_grid(rows = vars(component),
             cols = vars(expId))

loadings.vrt.plt + rt.binned.plt +
  plot_layout(widths=c(1,1.5))

```

### Models

```{r print_submem_rt_models, echo=F, results="asis", eval=T}
for (pc in 1:ncomp) {
  tidy(models.recog.rt[[pc]], effects = "fixed", conf.int = T, conf.level = 0.95) %>% 
    select(term, estimate, conf.low, conf.high, p.value, std.error, df) %>% 
    kable(caption=paste("PC", pc, ": ", formula(mod)[3], sep=""),
          digits=3) %>% 
    kable_styling() %>% 
    cat()
  
  tidy(models.recog.rt[[pc]], effects = "ran_pars", scales = "vcov") %>% 
    select(term, estimate) %>% 
    kable(digits=3, caption="Random effects") %>% 
    kable_styling() %>% 
    cat()
}
```

## Save

```{r save_models, echo=F, eval=run_models}

save(models, 
     models.compact.no.mismatch, 
     models.compact.no.accuracy,
     models.rt, 
     recog.lmer.models,
     models.recog.rt,
     trial_hist_mods,
     trial_hist_mods.correct,
     compact.pc2.accuracy.only.model, 
     recog.lmer.models,
     models.recog.rt,
     file="tpca_models.RData")

```
